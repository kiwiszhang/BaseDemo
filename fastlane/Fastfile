default_platform(:ios)

platform :ios do
  # --- é‡è¦é…ç½®ï¼šè¯·æ ¹æ®ä½ çš„é¡¹ç›®ä¿®æ”¹ä¸‹é¢çš„ä¿¡æ¯ ---
  app_scheme = "MobileProject"
  app_workspace = "MobileProject.xcworkspace"
  # app_project = "MobileProject.xcodeproj"
  app_bundle_id = "com.tayue.chatinfo"
  
  pgy_api_key = "0fb4b570bc9141197a69bb6a205e45a5"
  # --- é…ç½®ç»“æŸ ---
    
  desc "æ‰“åŒ…åº”ç”¨å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±è¿›è¡Œæµ‹è¯• (DEBUGæ¨¡å¼)" # æ›´æ–°äº†æè¿°
  lane :beta do
    puts "ğŸš€ å¼€å§‹æ‰“åŒ…åº”ç”¨ (DEBUG æ¨¡å¼)..."

    gym(
      scheme: app_scheme,
      workspace: app_workspace,
      # project: app_project,
      export_method: "ad-hoc",
      configuration: "Debug",
      output_directory: "./build",
      clean: true,
      xcargs: "-allowProvisioningUpdates"
      # include_bitcode: false, # Debugæ¨¡å¼ä¸‹é€šå¸¸ä¸éœ€è¦bitcodeï¼Œå¯ä»¥è®¾ä¸ºfalse
      # include_symbols: true   # Debugæ¨¡å¼é»˜è®¤ä¼šåŒ…å«ç¬¦å·
    )

    puts "ğŸ“¦ åº”ç”¨æ‰“åŒ…å®Œæˆ (DEBUG æ¨¡å¼)ï¼å‡†å¤‡ä¸Šä¼ åˆ°è’²å…¬è‹±..."

    pgyer(
      api_key: pgy_api_key,
      update_description: "æ–°çš„DEBUGæµ‹è¯•ç‰ˆæœ¬å·²ä¸Šä¼ ï¼æœ¬æ¬¡æ›´æ–°å†…å®¹ï¼šä¿®å¤äº†ä¸€äº›å°bugï¼Œä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒã€‚" # æ›´æ–°äº†æè¿°
    )

    puts "ğŸ‰ DEBUGæ¨¡å¼åº”ç”¨æˆåŠŸæ‰“åŒ…å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±ï¼å¿«å»è’²å…¬è‹±çœ‹çœ‹å§ï¼"
  end

  desc "æ‰“åŒ…åº”ç”¨å¹¶ä¸Šä¼ åˆ° App Store Connect è¿›è¡Œå‘å¸ƒ"
  lane :release do
    puts "ğŸš€ å¼€å§‹ä¸º App Store æ‰“åŒ…åº”ç”¨..."

    # (å¯é€‰ä½†æ¨è) è‡ªåŠ¨ç®¡ç†è¯ä¹¦å’Œæè¿°æ–‡ä»¶
    # match(type: "appstore", app_identifier: app_bundle_id, readonly: true)

    gym(
      scheme: app_scheme,
      workspace: app_workspace,
      export_method: "app-store",
      output_directory: "./build",
      clean: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "ğŸ“¦ åº”ç”¨æ‰“åŒ…å®Œæˆï¼å‡†å¤‡ä¸Šä¼ åˆ° App Store Connect..."

    # ä¸Šä¼ åˆ° App Store Connectï¼Œä½¿ç”¨å¯†é’¥å†…å®¹
    upload_to_app_store(
      force: true,
      itc_provider: "NKTVSPZ2V9",
      app_identifier: app_bundle_id,
      skip_metadata: true,
      skip_screenshots: true,
      api_key_path: "./apiKey.json",
      precheck_include_in_app_purchases: false
    )

    puts "ğŸ‰ åº”ç”¨æˆåŠŸæ‰“åŒ…å¹¶ä¸Šä¼ åˆ° App Store Connectï¼"
    puts "è¯·ç™»å½• App Store Connect åå°ï¼Œé€‰æ‹©åˆšæ‰ä¸Šä¼ çš„æ„å»ºç‰ˆæœ¬ï¼Œç„¶åæäº¤å®¡æ ¸ã€‚"
  end
end
